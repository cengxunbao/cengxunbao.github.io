<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B·∫£o H√†nh - Auto Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --dark: #1e293b; --light: #f8fafc; --border: #e2e8f0; --purple: #8b5cf6; --cloud: #0ea5e9;
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1500px; margin: auto; }

        header { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
            color: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        }
        .stats-group { display: flex; gap: 15px; }
        .stat-card { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-card span { display: block; font-size: 22px; font-weight: 800; }
        .stat-card label { font-size: 11px; text-transform: uppercase; opacity: 0.8; }

        .main-grid { display: grid; grid-template-columns: 360px 1fr; gap: 25px; }
        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

        .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        h3 { margin: 0 0 20px 0; font-size: 18px; color: var(--dark); }

        .form-group { margin-bottom: 16px; }
        label { display: block; font-weight: 600; font-size: 12px; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; 
            font-size: 14px; box-sizing: border-box; background: #fcfcfd;
        }
        .loan-banner { background: #fff7ed; border: 1px solid #fed7aa; padding: 15px; border-radius: 12px; border-left: 4px solid var(--warning); margin: 20px 0; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-cloud { background: var(--cloud); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--dark); }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8fafc; padding: 14px; text-align: left; font-size: 12px; color: #64748b; border-bottom: 2px solid #f1f5f9; }
        td { padding: 16px 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: top; }
        
        .copy-btn { 
            display: inline-flex; align-items: center; background: #f1f5f9; border: 1px solid #e2e8f0; 
            padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer; margin-left: 5px; color: #475569;
        }
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; border: none; }
        .status-0 { background: #fee2e2; color: #dc2626; }
        .status-1 { background: #fef3c7; color: #d97706; }
        .status-2 { background: #dcfce7; color: #16a34a; }
        .status-3 { background: #e0e7ff; color: #4f46e5; }
        
        .loan-item { color: var(--purple); font-weight: 700; }
        .returned { text-decoration: line-through; opacity: 0.5; }

        #cloudStatus { font-size: 12px; padding: 5px 12px; border-radius: 20px; background: rgba(255,255,255,0.1); display: flex; align-items: center; gap: 5px; }
        .loading-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 20px; border-radius: 30px; font-size: 13px; display: none; z-index: 1000; box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
        @media print { .no-print { display: none !important; } #printTicket { display: block !important; } }
        #printTicket { display: none; font-family: sans-serif; }
    </style>
</head>
<body>

<div id="toast">Th√¥ng b√°o</div>

<div class="container">
    <header class="no-print">
        <div>
            <h1 style="margin:0; font-size: 22px;">M√ÅY T√çNH NH∆†N TR·∫†CH</h1>
            <div id="cloudStatus"><div class="loading-dot" id="cloudDot"></div> <span id="cloudMsg">ƒêang k·∫øt n·ªëi Google Sheets...</span></div>
        </div>
        <div class="stats-group">
            <div class="stat-card"><label>T·ªïng ƒë∆°n</label><span id="countTotal">0</span></div>
            <div class="stat-card" style="color: #fbbf24;"><label>ƒêang m∆∞·ª£n</label><span id="countLoan">0</span></div>
        </div>
        <div class="btn-group">
            <button class="btn btn-cloud" onclick="restoreFromCloud()">üîÑ T·∫£i l·∫°i d·ªØ li·ªáu</button>
            <button class="btn btn-outline" onclick="exportExcel()">üìä Xu·∫•t Excel</button>
        </div>
    </header>

    <div class="main-grid">
        <div class="card no-print">
            <h3 id="formTitle">‚ûï T·∫°o ƒê∆°n B·∫£o H√†nh</h3>
            <form id="bhForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>N∆°i nh·∫≠n b·∫£o h√†nh</label>
                    <input type="text" id="toLoc" list="partnerList" placeholder="T√™n c√¥ng ty nh·∫≠n BH..." required>
                    <datalist id="partnerList"></datalist>
                </div>
                <div class="form-group">
                    <label>Kh√°ch h√†ng (T√™n & SƒêT)</label>
                    <input type="text" id="custInfo" placeholder="VD: Anh Tu·∫•n - 0908123456" required>
                </div>
                <div class="form-group">
                    <label>S·∫£n ph·∫©m l·ªói</label>
                    <input type="text" id="prodName" placeholder="T√™n s·∫£n ph·∫©m" required style="margin-bottom:8px;">
                    <input type="text" id="prodSerial" placeholder="S·ªë Serial / IMEI">
                </div>
                <div class="form-group">
                    <label>T√¨nh tr·∫°ng l·ªói</label>
                    <textarea id="prodIssue" rows="2" placeholder="M√¥ t·∫£ l·ªói..."></textarea>
                </div>
                <div class="loan-banner">
                    <label style="color: #9a3412;">üéÅ ƒê·ªì cho kh√°ch m∆∞·ª£n</label>
                    <input type="text" id="loanItem" placeholder="Linh ki·ªán cho m∆∞·ª£n t·∫°m">
                </div>
                <div class="btn-group">
                    <button type="submit" id="submitBtn" class="btn btn-primary" style="flex:1; justify-content:center;">üíæ L∆ØU & ƒê·ªíNG B·ªò</button>
                    <button type="button" id="cancelBtn" class="btn btn-outline" style="display:none;" onclick="resetForm()">H·ªßy</button>
                </div>
            </form>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;" class="no-print">
                <input type="text" id="searchBox" placeholder="T√¨m ki·∫øm..." onkeyup="render()" style="max-width:350px;">
                <select id="filterStatus" onchange="render()" style="width:180px;">
                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="0">Ch·ªù g·ª≠i ƒëi</option>
                    <option value="1">ƒêang b·∫£o h√†nh</option>
                    <option value="2">ƒê√£ s·ª≠a xong</option>
                    <option value="3">ƒê√£ xong ƒë∆°n</option>
                    <option value="loan">Ch∆∞a tr·∫£ ƒë·ªì</option>
                </select>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ng√†y</th>
                            <th>Kh√°ch & S·∫£n ph·∫©m</th>
                            <th>N∆°i BH</th>
                            <th>ƒê·ªì m∆∞·ª£n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th class="no-print">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="printTicket">
    <div style="text-align:center; border-bottom:1px solid #000; padding-bottom:10px;">
        <h2>M√ÅY T√çNH NH∆†N TR·∫†CH</h2>
        <p>Phi·∫øu Ti·∫øp Nh·∫≠n B·∫£o H√†nh</p>
    </div>
    <div id="printContent" style="padding:20px 0;"></div>
</div>

<script>
    // --- C·∫§U H√åNH GOOGLE SHEETS ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZKTxQweonx1b1J59qS0P2UGIyBoWsLgTjjkP0vdqqc9KxVxpDC-Fe60IWGmaonepMCw/exec';

    let db = JSON.parse(localStorage.getItem('nt_v6_db') || '[]');
    let partners = JSON.parse(localStorage.getItem('nt_v6_partners') || '["Vi t√≠nh Nguy·ªÖn Th·∫Øng"]');

    window.onload = () => {
        restoreFromCloud();
    };

    async function save() {
        localStorage.setItem('nt_v6_db', JSON.stringify(db));
        localStorage.setItem('nt_v6_partners', JSON.stringify(partners));
        render();
        await backupToCloud();
    }

    function updateCloudUI(status, msg) {
        const dot = document.getElementById('cloudDot');
        const text = document.getElementById('cloudMsg');
        text.innerText = msg;
        if(status === 'loading') dot.style.background = '#f59e0b';
        if(status === 'success') dot.style.background = '#10b981';
        if(status === 'error') dot.style.background = '#ef4444';
    }

    async function backupToCloud() {
        if (!GOOGLE_SCRIPT_URL.startsWith('http')) return;
        updateCloudUI('loading', 'ƒêang sao l∆∞u Sheets...');
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Quan tr·ªçng ƒë·ªÉ tr√°nh l·ªói CORS
                body: JSON.stringify({db, partners})
            });
            updateCloudUI('success', 'ƒê√£ l∆∞u l√™n Google Sheets');
        } catch (err) {
            updateCloudUI('error', 'L·ªói k·∫øt n·ªëi Sheets');
        }
    }

    async function restoreFromCloud() {
        if (!GOOGLE_SCRIPT_URL.startsWith('http')) {
            updateCloudUI('error', 'Ch∆∞a c·∫•u h√¨nh Link Sheets');
            return;
        }
        updateCloudUI('loading', 'ƒêang t·∫£i t·ª´ Sheets...');
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL);
            const data = await res.json();
            if (data) {
                db = data.db || [];
                partners = data.partners || ["Vi t√≠nh Nguy·ªÖn Th·∫Øng"];
                localStorage.setItem('nt_v6_db', JSON.stringify(db));
                localStorage.setItem('nt_v6_partners', JSON.stringify(partners));
                render();
                updateCloudUI('success', 'ƒê√£ ƒë·ªìng b·ªô');
                showToast('ƒê√£ t·∫£i d·ªØ li·ªáu m·ªõi nh·∫•t!');
            }
        } catch (err) {
            updateCloudUI('error', 'L·ªói t·∫£i d·ªØ li·ªáu');
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    function copyText(text) {
        let cleanText = text;
        const phoneMatch = text.match(/\d{9,11}/);
        if (phoneMatch) cleanText = phoneMatch[0];
        navigator.clipboard.writeText(cleanText);
        showToast('ƒê√£ copy: ' + cleanText);
    }

    const form = document.getElementById('bhForm');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const editId = document.getElementById('editId').value;
        const toLoc = document.getElementById('toLoc').value;

        const data = {
            id: editId ? parseInt(editId) : Date.now(),
            date: editId ? db.find(x => x.id == editId).date : new Date().toLocaleDateString('vi-VN'),
            customer: document.getElementById('custInfo').value,
            product: document.getElementById('prodName').value,
            serial: document.getElementById('prodSerial').value,
            issue: document.getElementById('prodIssue').value,
            to: toLoc,
            loanItem: document.getElementById('loanItem').value,
            loanReturned: editId ? db.find(x => x.id == editId).loanReturned : false,
            status: editId ? db.find(x => x.id == editId).status : 0
        };

        if (editId) {
            const idx = db.findIndex(i => i.id == editId);
            db[idx] = data;
        } else {
            db.unshift(data);
        }

        if(!partners.includes(toLoc)) partners.push(toLoc);
        save();
        resetForm();
    });

    function resetForm() {
        form.reset();
        document.getElementById('editId').value = '';
        document.getElementById('formTitle').innerText = '‚ûï T·∫°o ƒê∆°n B·∫£o H√†nh';
        document.getElementById('submitBtn').innerText = 'üíæ L∆ØU & ƒê·ªíNG B·ªò';
        document.getElementById('cancelBtn').style.display = 'none';
    }

    function editItem(id) {
        const item = db.find(i => i.id === id);
        document.getElementById('editId').value = item.id;
        document.getElementById('toLoc').value = item.to;
        document.getElementById('custInfo').value = item.customer;
        document.getElementById('prodName').value = item.product;
        document.getElementById('prodSerial').value = item.serial;
        document.getElementById('prodIssue').value = item.issue;
        document.getElementById('loanItem').value = item.loanItem;
        document.getElementById('formTitle').innerText = 'üìù S·ª≠a Th√¥ng Tin';
        document.getElementById('submitBtn').innerText = 'C·∫¨P NH·∫¨T & ƒê·ªíNG B·ªò';
        document.getElementById('cancelBtn').style.display = 'inline-block';
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function render() {
        const tbody = document.getElementById('tableBody');
        const search = document.getElementById('searchBox').value.toLowerCase();
        const filter = document.getElementById('filterStatus').value;
        tbody.innerHTML = '';
        
        let loanCount = 0;
        const filtered = db.filter(i => {
            const mS = i.customer.toLowerCase().includes(search) || i.product.toLowerCase().includes(search) || (i.serial && i.serial.toLowerCase().includes(search));
            let mF = filter === 'loan' ? (i.loanItem && !i.loanReturned) : (filter === 'all' || i.status == filter);
            return mS && mF;
        });

        filtered.forEach(item => {
            if(item.loanItem && !item.loanReturned) loanCount++;
            tbody.innerHTML += `
                <tr>
                    <td style="font-size:11px;">${item.date}</td>
                    <td>
                        <div style="font-weight:700;">${item.customer} <span class="copy-btn no-print" onclick="copyText('${item.customer}')">üìã</span></div>
                        <div style="color:var(--primary); font-size:13px; margin-top:3px;">${item.product}</div>
                        ${item.serial ? `<div style="font-size:11px; color:#94a3b8;">SN: ${item.serial} <span class="copy-btn no-print" onclick="copyText('${item.serial}')">üìã</span></div>` : ''}
                    </td>
                    <td>${item.to}</td>
                    <td>
                        <span class="${item.loanReturned ? 'returned' : 'loan-item'}">${item.loanItem || '-'}</span>
                        ${(item.loanItem && !item.loanReturned) ? `<br><button class="btn no-print" onclick="toggleLoan(${item.id})" style="font-size:10px; padding:2px 5px; margin-top:5px;">Thu h·ªìi</button>` : ''}
                    </td>
                    <td>
                        <select onchange="changeStatus(${item.id}, this.value)" class="badge status-${item.status}">
                            <option value="0" ${item.status==0?'selected':''}>Ch·ªù g·ª≠i</option>
                            <option value="1" ${item.status==1?'selected':''}>ƒêang BH</option>
                            <option value="2" ${item.status==2?'selected':''}>ƒê√£ xong</option>
                            <option value="3" ${item.status==3?'selected':''}>ƒê√£ tr·∫£ kh√°ch</option>
                        </select>
                    </td>
                    <td class="no-print">
                        <div class="btn-group">
                            <button class="btn btn-outline" onclick="printTicket(${item.id})">üñ®Ô∏è</button>
                            <button class="btn btn-outline" onclick="editItem(${item.id})">‚úèÔ∏è</button>
                            <button class="btn btn-danger" onclick="deleteItem(${item.id})">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `;
        });
        document.getElementById('countTotal').innerText = db.length;
        document.getElementById('countLoan').innerText = loanCount;
        document.getElementById('partnerList').innerHTML = partners.map(p => `<option value="${p}">`).join('');
    }

    function toggleLoan(id) {
        const idx = db.findIndex(i => i.id === id);
        db[idx].loanReturned = true;
        save();
    }

    function changeStatus(id, val) {
        const idx = db.findIndex(i => i.id === id);
        db[idx].status = parseInt(val);
        save();
    }

    function deleteItem(id) {
        if(confirm('X√≥a ƒë∆°n n√†y?')) {
            db = db.filter(i => i.id !== id);
            save();
        }
    }

    function printTicket(id) {
        const item = db.find(i => i.id === id);
        document.getElementById('printContent').innerHTML = `
            <p><strong>Kh√°ch h√†ng:</strong> ${item.customer}</p>
            <p><strong>Ng√†y nh·∫≠n:</strong> ${item.date}</p>
            <p><strong>Thi·∫øt b·ªã:</strong> ${item.product}</p>
            <p><strong>S·ªë Serial:</strong> ${item.serial || '...'}</p>
            <p><strong>T√¨nh tr·∫°ng:</strong> ${item.issue}</p>
            ${item.loanItem ? `<p><strong>ƒê·ªì cho m∆∞·ª£n:</strong> ${item.loanItem}</p>` : ''}
        `;
        window.print();
    }

    function exportExcel() {
        const data = db.map(i => ({
            "NG√ÄY": i.date, "KH√ÅCH H√ÄNG": i.customer, "S·∫¢N PH·∫®M": i.product, "Serial": i.serial,
            "N∆†I NH·∫¨N BH": i.to, "ƒê·ªí M∆Ø·ª¢N": i.loanItem, "TR·∫†NG TH√ÅI": i.status == 3 ? "Xong" : "ƒêang x·ª≠ l√Ω"
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "BaoHanh");
        XLSX.writeFile(wb, "BaoHanh_NhonTrach.xlsx");
    }

    render();
</script>
</body>
</html>
